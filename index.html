<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ выручки по городам</title>
	<link rel="stylesheet" href="style1.css">
	<style>
	    .status {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
			margin-bottom: 10px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
	</style>
</head>
<body>
    <h1>Анализ выручки по городам (топ 10)</h1>
    
    <div class="controls">
		<div id="status" class="status info">Выберите CSV файл для анализа</div>
        <div class="control-group">
            <!--label for="file-input">Выберите CSV файл для анализа:</label-->
            <input type="file" id="file-input" accept=".csv" class="file-input">
        </div>
        <div class="control-group">
            <label for="year-select">Выберите год:</label>
            <select id="year-select" disabled style="margin-top: 20px";>
                <option value="">-- Сначала загрузите данные --</option>
            </select>
        </div>
    </div>
    
    <div class="table-container">
        <table id="revenue-table">
            <thead>
                <tr>
                    <th>Город</th>
                    <th>Штат</th>
                    <th>Выручка ($)</th>
                    <th>Доля (%)</th>
                    <th>Визуализация доли</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr>
                    <td colspan="5" style="text-align: center;">Нет данных для отображения</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="summary" id="summary">
        Общая выручка: <span class="highlight">$0.00</span>
    </div>

    <script>
        // Переменная для хранения загруженных данных
        let csvData = null;

        // Функция для чтения CSV файла
        function readCSVFile(file) {
            const statusElement = document.getElementById('status');
            
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('Файл не выбран'));
                    return;
                }

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    reject(new Error('Пожалуйста, выберите CSV файл'));
                    return;
                }

                statusElement.textContent = 'Чтение файла...';
                statusElement.className = 'status info';

                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    if (!content || content.trim().length === 0) {
                        reject(new Error('Файл пустой'));
                        return;
                    }
                    
                    statusElement.textContent = 'Файл успешно загружен!';
                    statusElement.className = 'status success';
                    resolve(content);
                };
                
                reader.onerror = function() {
                    reject(new Error('Ошибка чтения файла'));
                };
                
                reader.readAsText(file);
            });
        }

        // Функция для парсинга CSV данных
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const result = [];
            const headers = lines[0].split(',').map(header => header.trim());
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // Пропускаем пустые строки
                
                const obj = {};
                // Более надежное разделение строки с учетом запятых в значениях
                const currentline = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                for (let j = 0; j < headers.length; j++) {
                    let value = currentline[j] ? currentline[j].trim() : '';
                    // Убираем кавычки если они есть
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }
                    obj[headers[j]] = value;
                }
                
                result.push(obj);
            }
            
            return result;
        }

        // Функция для расчета выручки по городам за указанный год
        function calculateRevenueByCity(data, year) {
            const revenueByCity = {};
            
            data.forEach(row => {
                if (!row.order_date) return;
                
                const orderYear = row.order_date.substring(0, 4);
                if (orderYear === year) {
                    const city = row.city || 'Неизвестно';
                    const state = row.state || 'Неизвестно';
                    const sales = parseFloat(row.sales) || 0;
                    
                    if (!revenueByCity[city]) {
                        revenueByCity[city] = {
                            state: state,
                            revenue: 0
                        };
                    }
                    
                    revenueByCity[city].revenue += sales;
                }
            });
            
            return revenueByCity;
        }

        // Функция для получения топ-10 городов по выручке
        function getTopCities(revenueByCity, limit = 10) {
            const cities = Object.keys(revenueByCity).map(city => ({
                city,
                state: revenueByCity[city].state,
                revenue: revenueByCity[city].revenue
            }));
            
            // Сортировка по убыванию выручки
            cities.sort((a, b) => b.revenue - a.revenue);
            
            return cities.slice(0, limit);
        }

        // Функция для расчета долей выручки
        function calculateShares(topCities, totalRevenue) {
            return topCities.map(city => ({
                ...city,
                share: (city.revenue / totalRevenue) * 100
            }));
        }

        // Функция для форматирования чисел в денежный формат
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Функция для получения доступных годов из данных
        function getAvailableYears(data) {
            const years = new Set();
            
            data.forEach(row => {
                if (row.order_date) {
                    const year = row.order_date.substring(0, 4);
                    if (year) years.add(year);
                }
            });
            
            return Array.from(years).sort();
        }

        function calculateTotalRevenue(data, year) {
            return data.reduce((total, { order_date, sales }) => {
                const orderYear = order_date?.substring(0, 4);
                return orderYear === year ? total + (parseFloat(sales) || 0) : total;
            }, 0);            
        }        

        // Функция для обновления таблицы
        function updateTable(year, data) {
            const revenueByCity = calculateRevenueByCity(data, year);
            const topCities = getTopCities(revenueByCity);
            
            if (topCities.length === 0) {
                const tableBody = document.getElementById('table-body');
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Нет данных для выбранного года</td></tr>';
                document.getElementById('summary').innerHTML = `Общая выручка за ${year} год: <span class="highlight">${formatCurrency(0)}</span>`;
                return;
            }
            
            // Общая выручка за год
            //const totalRevenue = topCities.reduce((sum, city) => sum + city.revenue, 0); // ошибочный вариант
            const totalRevenue = calculateTotalRevenue(data, year);            
            
            // Расчет долей
            const citiesWithShares = calculateShares(topCities, totalRevenue);
            
            // Обновление таблицы
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            citiesWithShares.forEach(city => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${city.city}</td>
                    <td>${city.state}</td>
                    <td>${formatCurrency(city.revenue)}</td>
                    <td>${city.share.toFixed(2)}%</td>
                    <td>
                        <div class="percentage-bar">
                            <div class="percentage-fill" style="width: ${Math.min(city.share, 100)}%"></div>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Обновление сводки
            const summaryElement = document.getElementById('summary');
            summaryElement.innerHTML = `
                Общая выручка за ${year} год: <span class="highlight">${formatCurrency(totalRevenue)}</span>
            `;
        }

        // Функция для инициализации выбора года
        function initYearSelect(years) {
            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = '';
            
            if (years.length === 0) {
                yearSelect.innerHTML = '<option value="">Нет данных</option>';
                yearSelect.disabled = true;
                return;
            }
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Выбираем последний год по умолчанию
            yearSelect.value = years[years.length - 1];
            yearSelect.disabled = false;
        }

        // Функция для обработки загруженных данных
        function processData(data) {
            if (data.length === 0) {
                document.getElementById('status').textContent = 'В файле нет данных для анализа';
                document.getElementById('status').className = 'status error';
                return;
            }
            
            // Получаем доступные годы
            const years = getAvailableYears(data);
            
            if (years.length === 0) {
                document.getElementById('status').textContent = 'Не найдено данных с датами заказов';
                document.getElementById('status').className = 'status error';
                return;
            }
            
            // Инициализируем выбор года
            initYearSelect(years);
            
            // Обновляем таблицу для выбранного года
            updateTable(years[years.length - 1], data);
            
            // Сохраняем данные для повторного использования
            csvData = data;
            
            // Обработчик изменения года
            document.getElementById('year-select').addEventListener('change', function() {
                updateTable(this.value, csvData);
            });
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const yearSelect = document.getElementById('year-select');
            
            // Обработчик выбора файла
            fileInput.addEventListener('change', async function(event) {
                const file = event.target.files[0];
                const statusElement = document.getElementById('status');
                
                try {
                    const csvContent = await readCSVFile(file);
                    const parsedData = parseCSV(csvContent);
                    processData(parsedData);
                } catch (error) {
                    console.error('Ошибка:', error);
                    statusElement.textContent = `Ошибка: ${error.message}`;
                    statusElement.className = 'status error';
                    
                    // Сбрасываем выбор года
                    yearSelect.innerHTML = '<option value="">-- Сначала загрузите данные --</option>';
                    yearSelect.disabled = true;
                    
                    // Очищаем таблицу
                    document.getElementById('table-body').innerHTML = 
                        '<tr><td colspan="5" style="text-align: center;">Нет данных для отображения</td></tr>';
                    document.getElementById('summary').innerHTML = 
                        'Общая выручка: <span class="highlight">$0.00</span>';
                }
            });
        });
    </script>
</body>
</html>